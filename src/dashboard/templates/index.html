{% extends "base.html" %} {% block title %}SessionSentry - Dashboard{% endblock
%} {% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
    >
        <h1 class="h2">Dashboard</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    id="refresh-btn"
                >
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary">
                    Export
                </button>
            </div>
            <div class="dropdown">
                <button
                    class="btn btn-sm btn-outline-secondary dropdown-toggle"
                    type="button"
                    id="timeRangeDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                >
                    <i class="far fa-calendar-alt"></i>
                    <span id="selected-range">Last 7 days</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="timeRangeDropdown">
                    <li>
                        <a
                            class="dropdown-item time-range"
                            href="#"
                            data-days="1"
                            >Last 24 hours</a
                        >
                    </li>
                    <li>
                        <a
                            class="dropdown-item time-range"
                            href="#"
                            data-days="7"
                            >Last 7 days</a
                        >
                    </li>
                    <li>
                        <a
                            class="dropdown-item time-range"
                            href="#"
                            data-days="30"
                            >Last 30 days</a
                        >
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div
                        class="d-flex justify-content-between align-items-center"
                    >
                        <div>
                            <h6 class="card-title text-white">Total Logins</h6>
                            <h2 class="card-text" id="total-logins">--</h2>
                        </div>
                        <i class="fas fa-sign-in-alt fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div
                        class="d-flex justify-content-between align-items-center"
                    >
                        <div>
                            <h6 class="card-title text-white">Total Logouts</h6>
                            <h2 class="card-text" id="total-logouts">--</h2>
                        </div>
                        <i class="fas fa-sign-out-alt fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div
                        class="d-flex justify-content-between align-items-center"
                    >
                        <div>
                            <h6 class="card-title text-white">Active Users</h6>
                            <h2 class="card-text" id="active-users">--</h2>
                        </div>
                        <i class="fas fa-users fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <div
                        class="d-flex justify-content-between align-items-center"
                    >
                        <div>
                            <h6 class="card-title text-white">Anomalies</h6>
                            <h2 class="card-text" id="total-anomalies">--</h2>
                        </div>
                        <i
                            class="fas fa-exclamation-triangle fa-3x opacity-50"
                        ></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line me-2"></i> Login/Logout Trends
                </div>
                <div class="card-body">
                    <canvas id="login-trend-chart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-2"></i> Login Distribution by
                    Hour
                </div>
                <div class="card-body">
                    <canvas id="login-hour-chart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Anomalies -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-exclamation-triangle me-2"></i> Recent
                    Anomalies
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table
                            class="table table-striped table-hover"
                            id="anomalies-table"
                        >
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Username</th>
                                    <th>Event Type</th>
                                    <th>Source</th>
                                    <th>Reason</th>
                                    <th>Severity</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center">
                                        Loading anomalies...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end mt-3">
                        <a
                            href="/anomalies"
                            class="btn btn-outline-primary btn-sm"
                            >View All Anomalies</a
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    // Global variables
    let selectedDays = 7;
    let loginTrendChart = null;
    let loginHourChart = null;

    // Fetch dashboard data
    async function fetchDashboardData() {
        try {
            // Show loading indicators
            document.getElementById('total-logins').textContent = "...";
            document.getElementById('total-logouts').textContent = "...";
            document.getElementById('total-anomalies').textContent = "...";
            document.getElementById('active-users').textContent = "...";

            // Fetch stats from API
            const response = await fetch(`/api/stats?days=${selectedDays}`);
            const data = await response.json();

            // Update summary cards
            document.getElementById('total-logins').textContent = data.total_logins;
            document.getElementById('total-logouts').textContent = data.total_logouts;
            document.getElementById('total-anomalies').textContent = data.total_anomalies;

            // Calculate active users (simple estimate: logins - logouts)
            const activeUsers = Math.max(0, data.total_logins - data.total_logouts);
            document.getElementById('active-users').textContent = activeUsers;

            // Update login trend chart
            updateLoginTrendChart(data.events_by_day);

            // Update login hour distribution chart
            updateLoginHourChart(data.events_by_hour);

            // Update anomalies table
            fetchRecentAnomalies();

            // Update last updated time
            updateLastUpdated();
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
        }
    }

    // Update login trend chart
    function updateLoginTrendChart(eventsData) {
        const labels = eventsData.map(item => item.date);
        const loginData = eventsData.map(item => item.login);
        const logoutData = eventsData.map(item => item.logout);

        if (loginTrendChart) {
            loginTrendChart.destroy();
        }

        const ctx = document.getElementById('login-trend-chart').getContext('2d');
        loginTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Logins',
                        data: loginData,
                        backgroundColor: 'rgba(13, 110, 253, 0.2)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    },
                    {
                        label: 'Logouts',
                        data: logoutData,
                        backgroundColor: 'rgba(25, 135, 84, 0.2)',
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Update login hour distribution chart
    function updateLoginHourChart(hourData) {
        const labels = hourData.map(item => `${item.hour}:00`);
        const loginData = hourData.map(item => item.login);

        if (loginHourChart) {
            loginHourChart.destroy();
        }

        const ctx = document.getElementById('login-hour-chart').getContext('2d');
        loginHourChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Logins by Hour',
                        data: loginData,
                        backgroundColor: 'rgba(13, 110, 253, 0.7)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Fetch recent anomalies
    async function fetchRecentAnomalies() {
        try {
            const response = await fetch(`/api/anomalies?days=${selectedDays}&limit=5`);
            const anomalies = await response.json();

            const tableBody = document.querySelector('#anomalies-table tbody');

            if (anomalies.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No anomalies detected</td></tr>';
                return;
            }

            tableBody.innerHTML = '';

            anomalies.forEach(anomaly => {
                const severityClass = anomaly.severity >= 7 ? 'anomaly-high' :
                                      anomaly.severity >= 4 ? 'anomaly-medium' : 'anomaly-low';

                const row = document.createElement('tr');
                row.className = severityClass;

                row.innerHTML = `
                    <td>${new Date(anomaly.detected_at).toLocaleString()}</td>
                    <td>${anomaly.username}</td>
                    <td>${anomaly.event_type}</td>
                    <td>${anomaly.source_address || 'N/A'}</td>
                    <td>${anomaly.description}</td>
                    <td>${anomaly.severity}/10</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary mark-false-positive" data-id="${anomaly.id}">
                            <i class="fas fa-check-circle"></i> False Positive
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            // Add event listeners for false positive buttons
            document.querySelectorAll('.mark-false-positive').forEach(button => {
                button.addEventListener('click', function() {
                    const anomalyId = this.getAttribute('data-id');
                    markAsFalsePositive(anomalyId);
                });
            });

        } catch (error) {
            console.error('Error fetching anomalies:', error);
        }
    }

    // Mark anomaly as false positive
    async function markAsFalsePositive(anomalyId) {
        try {
            const response = await fetch(`/api/mark_false_positive/${anomalyId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ notes: 'Marked as false positive from dashboard' })
            });

            const result = await response.json();

            if (result.success) {
                // Refresh anomalies display
                fetchRecentAnomalies();
            }
        } catch (error) {
            console.error('Error marking as false positive:', error);
        }
    }

    // Event handlers for time range selection
    document.querySelectorAll('.time-range').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            selectedDays = parseInt(this.getAttribute('data-days'));
            document.getElementById('selected-range').textContent = this.textContent;
            fetchDashboardData();
        });
    });

    // Event handler for refresh button
    document.getElementById('refresh-btn').addEventListener('click', function() {
        fetchDashboardData();
    });

    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetchDashboardData();

        // Set up auto-refresh every 5 minutes
        setInterval(fetchDashboardData, 5 * 60 * 1000);
    });
</script>
{% endblock %}
